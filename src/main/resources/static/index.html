<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Private Page</title>
  <style>
    body { margin: 0; font-family: sans-serif; background-color: #111; color: #fff; }

    /* --- NEW LOADER ---
       This is shown first to prevent the "flash" */
    #loader {
      position: fixed; top: 0; left: 0; width: 100%; height: 100vh;
      background-color: #000; display: flex; justify-content: center;
      align-items: center; z-index: 101; font-size: 18px;
    }

    #password-gate {
      position: fixed; top: 0; left: 0; width: 100%; height: 100vh;
      background-color: #000;
      display: none; /* Hidden by default */
      justify-content: center;
      align-items: center; flex-direction: column; z-index: 100;

      /* --- TRANSITION FOR SLIDE-UP --- */
      transition: transform 0.6s ease-in-out;
    }

    #password-gate button {
      background-color: #007bff;
      color: white;
      border: none;
      padding: 10px 15px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
      margin-top: 10px;
      filter: grayscale(100%);
      transition: filter 0.3s ease;
    }
    #password-gate button:hover, #password-gate button:active {
      filter: grayscale(0%);
    }

    #content-feed {
      display: none; /* Hidden by default */
    }
    #media-container { max-width: 800px; margin: 0 auto; padding-top: 30px; }

    .media-item {
      margin-bottom: 40px;
      border-bottom: 1px solid #333;
      padding-bottom: 20px;
      text-align: center;
    }

    .media-item img, .media-item video {
      max-width: 90%; height: auto; border-radius: 8px;
      display: block; margin: 0 auto;
      filter: grayscale(100%);
      transition: filter 0.3s ease;
    }

    .media-item:hover img, .media-item:hover video {
      filter: grayscale(0%);
    }

    .media-item video { max-height: 80vh; }

    #main-header {
      display: none; /* Hidden by default, shown for ADMIN */
      justify-content: center;
      align-items: center;
      padding: 15px 25px;
      background-color: #222;
      box-sizing: border-box;
      width: 100%;
      min-height: 60.5px;
    }

    #main-header #upload-link-container a {
      color: #00aaff;
      font-size: 18px;
      text-decoration: none;
      font-weight: bold;
      filter: grayscale(100%);
      transition: filter 0.3s ease;
    }
    #main-header #upload-link-container a:hover {
      text-decoration: underline;
      filter: grayscale(0%);
    }

    .delete-btn {
      background: #dc3545; color: white; border: none;
      padding: 5px 10px; cursor: pointer; margin-top: 10px;
      border-radius: 4px;
      filter: grayscale(100%);
      transition: filter 0.3s ease;
    }
    .delete-btn:hover, .delete-btn:active {
      filter: grayscale(0%);
    }

    .timestamp {
      font-size: 12px;
      color: #888;
      margin-top: 10px;
      margin-bottom: 5px;
    }
  </style>
</head>
<body>

<div id="loader">
  <p>Loading...</p>
</div>

<div id="password-gate">
  <h2>Enter Password</h2>
  <input type="password" id="password-input" />
  <button id="login-button">Enter</button>
  <p id="error-message" style="color: red;"></p>
</div>

<div id="content-feed">
  <div id="main-header">
    <div id="upload-link-container"></div>
  </div>
  <div id="media-container">
  </div>
</div>

<script>
  // Get all elements
  const loader = document.getElementById('loader');
  const gate = document.getElementById('password-gate');
  const feed = document.getElementById('content-feed');
  const loginButton = document.getElementById('login-button');
  const passwordInput = document.getElementById('password-input');
  const errorMessage = document.getElementById('error-message');
  const mediaContainer = document.getElementById('media-container');
  const uploadLinkContainer = document.getElementById('upload-link-container');
  const mainHeader = document.getElementById('main-header');

  /**
   * --- UPDATED checkPassword FUNCTION ---
   * Now triggers the "scroll up" transition
   */
  async function checkPassword() {
    const password = passwordInput.value;
    errorMessage.textContent = '';
    try {
      const response = await fetch('/api/authenticate', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ password: password })
      });

      if (response.ok) {
        const data = await response.json();
        sessionStorage.setItem("userRole", data.role);

        // --- TRIGGER THE TRANSITION ---
        gate.style.transform = 'translateY(-100%)'; // Slide up

        // Hide the gate from the DOM *after* it slides off-screen
        gate.addEventListener('transitionend', () => {
          gate.style.display = 'none';
        }, { once: true }); // 'once: true' removes the listener after it runs

        // Load the media content
        loadMedia();
      } else {
        errorMessage.textContent = 'Incorrect Password';
      }
    } catch (err) {
      errorMessage.textContent = 'Error contacting server.';
    }
  }

  // (formatDate function is unchanged)
  function formatDate(isoString) {
    if (!isoString) return '';
    const date = new Date(isoString);
    const day = String(date.getDate()).padStart(2, '0');
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const year = date.getFullYear();
    return `${day}-${month}-${year}`;
  }

  /**
   * --- UPDATED loadMedia FUNCTION ---
   * Now controls the loader, gate, and feed visibility
   */
  async function loadMedia() {
    try {
      const response = await fetch('/api/media');

      if (!response.ok) { // Not logged in
        loader.style.display = 'none'; // Hide loader
        feed.style.display = 'none';   // Hide feed
        gate.style.transform = 'translateY(0)'; // Reset gate position
        gate.style.display = 'flex';   // Show gate
        sessionStorage.removeItem("userRole");
        return;
      }

      // Logged in!
      loader.style.display = 'none'; // Hide loader
      gate.style.display = 'none';   // Hide gate
      feed.style.display = 'block';  // Show feed

      const data = await response.json();
      const mediaItems = data.posts;
      const userRole = data.userRole;
      sessionStorage.setItem("userRole", userRole);

      if (userRole === "ADMIN") {
        uploadLinkContainer.innerHTML = '<a href="/putThemHere.html">Upload New Media &rarr;</a>';
        mainHeader.style.display = 'flex'; // Show header for Admin
      } else {
        uploadLinkContainer.innerHTML = '';
        mainHeader.style.display = 'none'; // Hide header for User
      }

      mediaContainer.innerHTML = '';
      for (const item of mediaItems) {
        const div = document.createElement('div');
        div.className = 'media-item';

        const formattedDate = formatDate(item.timestamp);
        let htmlContent = '';

        if (item.mediaUrl) {
          if (item.mediaType.startsWith('image')) {
            htmlContent = `<img src="${item.mediaUrl}" alt="Media">`;
          } else if (item.mediaType.startsWith('video')) {
            htmlContent = `<video src="${item.mediaUrl}" controls></video>`;
          }
        }

        htmlContent += `<p class="timestamp">${formattedDate}</p>`;

        if (userRole === "ADMIN") {
          htmlContent += `
                            <button onclick="deleteMedia(${item.id})" class="delete-btn">
                                Delete
                            </button>
                        `;
        }
        div.innerHTML = htmlContent;
        mediaContainer.appendChild(div);
      }
    } catch (err) {
      console.error('Failed to load media:', err);
      loader.style.display = 'none'; // Hide loader
      gate.style.display = 'flex';   // Show gate on error
      feed.style.display = 'none';   // Hide feed
    }
  }

  // (deleteMedia function is unchanged)
  async function deleteMedia(id) {
    if (!confirm('Are you sure you want to delete this media?')) {
      return;
    }
    try {
      const response = await fetch('/api/media/' + id, {
        method: 'DELETE'
      });
      if (response.ok) {
        loadMedia();
      } else {
        alert('Delete failed. Your session may have expired.');
      }
    } catch (err) {
      alert('An error occurred: ' + err.message);
    }
  }

  // (Event listeners are unchanged)
  loginButton.addEventListener('click', checkPassword);
  passwordInput.addEventListener('keyup', (event) => {
    if (event.key === 'Enter') checkPassword();
  });

  /**
   * --- UPDATED AUTO-LOGIN LOGIC ---
   * Now decides whether to show loader (for auto-login) or gate
   */
  const storedRole = sessionStorage.getItem("userRole");
  if (storedRole === "ADMIN" || storedRole === "USER") {
    // Loader is visible by default, try to auto-login
    loadMedia();
  } else {
    // Not logged in. Hide loader, show gate.
    loader.style.display = 'none';
    gate.style.display = 'flex';
  }
</script>
</body>
</html>